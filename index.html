<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Colorful Custom Hand AI Project (fcAI)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- ===== TensorFlow.js ===== -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-cpu"></script>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-layers"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

<style>
body {
  margin:0;
  background:#111;
  color:#fff;
  font-family:Arial, sans-serif;
  -webkit-user-select:none;
  user-select:none;
}

/* ===== video / canvas ===== */
#videoWrapper {
  position: relative;
  width:100%;
  max-width:420px;
  margin:0 auto;
  aspect-ratio:3/4;
  background:#000;
}
#video {
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
  opacity:0;
}
#renderCanvas {
  position:absolute;
  inset:0;
  z-index:2;
}

/* ===== Hand PNG Overlay ===== */
#handImageLayer {
  position:absolute;
  inset:0;
  pointer-events:none;
  z-index:5;
}
.hand-img {
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  width:70vmin;
  max-width:420px;
  opacity:0.30;      /* ← かなり薄め */
  display:none;
}
.hand-img.active {
  display:block;
}

/* ===== SVG overlay 無効化（削除しない） ===== */
#overlaySvg {
  display:none !important;
}

/* ===== HUD ===== */
#overlayHud {
  fill:#fff;
  font-size:12px;
}

/* ===== buttons ===== */
#controlPanel {
  text-align:center;
  margin-top:10px;
}
.sim-btn, button {
  margin:4px;
  padding:8px 12px;
  border-radius:10px;
  border:none;
  background:#444;
  color:#fff;
}

/* ===== DEBUG HUD ===== */
#debugHud {
  position:fixed;
  top:8px;
  left:8px;
  width:min(520px,calc(100vw - 16px));
  background:rgba(0,0,0,0.65);
  border-radius:10px;
  display:none;
  z-index:9999;
}
</style>
</head>
<body>

<!-- ===== DEBUG HUD ===== -->
<div id="debugHud">
  <pre id="debugText">booting...</pre>
</div>

<!-- ===== TOP ===== -->
<header id="topHeader">
  <div style="padding:8px">
    <h1 style="font-size:16px;margin:0">Colorful Custom Hand AI Project</h1>
  </div>
</header>

<!-- ===== APP ===== -->
<div id="appContainer">

  <div id="videoWrapper">

    <!-- camera -->
    <video id="video" autoplay playsinline></video>
    <canvas id="renderCanvas"></canvas>

    <!-- ===== Hand PNG overlay ===== -->
    <div id="handImageLayer">

      <!-- RELAX / OPEN -->
      <img id="img-open"
        class="hand-img active"
        src="hand_open.png"
        alt="open hand" />

      <!-- PHONE -->
      <img id="img-phone"
        class="hand-img"
        src="hand_hold.png"
        alt="phone hold" />

      <!-- PEN -->
      <img id="img-pen"
        class="hand-img"
        src="hand_pen.png"
        alt="pen hold" />

      <!-- KEY -->
      <img id="img-key"
        class="hand-img"
        src="hand_key.png"
        alt="key pinch" />

      <!-- EGG -->
      <img id="img-egg"
        class="hand-img"
        src="hand_egg.png"
        alt="egg grip" />

      <!-- SALUTE -->
      <img id="img-salute"
        class="hand-img"
        src="hand_salute.png"
        alt="salute" />
    </div>

    <!-- ===== SVG (残す・非表示) ===== -->
    <svg id="overlaySvg"
      viewBox="0 0 220 220"
      preserveAspectRatio="xMidYMid meet">
      <text id="overlayHud" x="110" y="210" text-anchor="middle">
        booting
      </text>
    </svg>

  </div>

  <!-- ===== RESULT ===== -->
  <div id="resultArea" style="text-align:center;margin-top:8px">
    <div id="result">State: RELAXED</div>
    <div id="status">booting...</div>
  </div>

  <!-- ===== CONTROLS ===== -->
  <div id="controlPanel">

    <button id="startCameraBtn">Start Camera</button>
    <br/>

    <button id="simEgg" class="sim-btn">EGG</button>
    <button id="simPen" class="sim-btn">Pen</button>
    <button id="simPhone" class="sim-btn">Phone</button>
    <button id="simKey" class="sim-btn">Key</button>
    <button id="simSalute" class="sim-btn">Salute</button>

    <br/>

    <button id="miniOpenBtn">Mini-Open</button>
    <button id="lockBtn">Lock</button>
    <button id="relaxBtn">Full Relax</button>

  </div>

</div>
<script>
(() => {

  // ======== DOM references ========
  const video        = document.getElementById('video');
  const renderCanvas = document.getElementById('renderCanvas');
  const renderCtx    = renderCanvas.getContext('2d');

  const resultEl     = document.getElementById('result');
  const statusEl     = document.getElementById('status');
  const hudText      = document.getElementById('overlayHud');

  const simEggBtn    = document.getElementById('simEgg');
  const simPenBtn    = document.getElementById('simPen');
  const simPhoneBtn  = document.getElementById('simPhone');
  const simKeyBtn    = document.getElementById('simKey');
  const simSaluteBtn = document.getElementById('simSalute');

  const miniOpenBtn  = document.getElementById('miniOpenBtn');
  const lockBtn      = document.getElementById('lockBtn');
  const relaxBtn     = document.getElementById('relaxBtn');
  const startCamBtn  = document.getElementById('startCameraBtn');

  // ======== State ========
  let model = null;
  let stream = null;

  let detectRunning = false;
  let drawRunning = false;

  let lockActive = false;
  let currentGroup = 'none';

  let lastGroups = [];
  let freezeUntil = 0;
  let freezeGroup = 'none';
  let freezeBoxes = [];

  let demoUntil = 0;

  let latestObjects = [];
  let latestHudLine = 'booting';

  // ======== FPS ========
  let drawFrameCount = 0;
  let drawFps = 0;
  let drawFpsT0 = performance.now();

  let detectCount = 0;
  let detectFps = 0;
  let detectFpsT0 = performance.now();

  // ======== Helpers ========
  function activateHand(group) {
    currentGroup = group;
    // ★ PNG切替は PART5 で追加
  }

  function getFreezeDurationMs() {
    return 5000; // ← あなた指定：5秒
  }

  function resizeRenderCanvas() {
    const dpr = window.devicePixelRatio || 1;
    const w = renderCanvas.clientWidth * dpr;
    const h = renderCanvas.clientHeight * dpr;
    if (renderCanvas.width !== w || renderCanvas.height !== h) {
      renderCanvas.width = w;
      renderCanvas.height = h;
    }
    renderCtx.setTransform(dpr,0,0,dpr,0,0);
  }

  function drawLoop() {
    requestAnimationFrame(drawLoop);

    drawFrameCount++;
    const now = performance.now();
    if (now - drawFpsT0 > 1000) {
      drawFps = drawFrameCount;
      drawFrameCount = 0;
      drawFpsT0 = now;
    }

    if (!video.videoWidth) return;

    resizeRenderCanvas();
    renderCtx.clearRect(0,0,renderCanvas.width,renderCanvas.height);
    renderCtx.drawImage(video,0,0,renderCanvas.clientWidth,renderCanvas.clientHeight);

    hudText.textContent = latestHudLine;
  }
  // ======== Load model ========
  async function loadModelIfNeeded() {
    if (model) return;
    statusEl.textContent = 'Loading COCO-SSD...';
    model = await cocoSsd.load();
    statusEl.textContent = 'Model loaded.';
    latestHudLine = 'COCO-SSD loaded';
  }

  // ======== Detection Loop ========
  async function runDetectionLoop() {
    if (!detectRunning) return;

    const loop = async () => {
      if (!detectRunning) return;

      const now = performance.now();

      if (lockActive) {
        latestHudLine = 'Locked';
        setTimeout(loop, 200);
        return;
      }

      if (now < freezeUntil) {
        latestHudLine = 'Auto freeze';
        setTimeout(loop, 200);
        return;
      }

      if (!model || !video.videoWidth) {
        setTimeout(loop, 200);
        return;
      }

      try {
        const predictions = await model.detect(video);

        detectCount++;
        const t = performance.now();
        if (t - detectFpsT0 > 1000) {
          detectFps = detectCount;
          detectCount = 0;
          detectFpsT0 = t;
        }

        let dominant = 'none';
        let bestScore = 0;

        predictions.forEach(p => {
          if (p.score < 0.3) return;

          const c = p.class.toLowerCase();
          let g = 'none';

          if (c === 'cell phone') g = 'phone';
          else if (['scissors','toothbrush','fork','knife','spoon'].includes(c)) g = 'pen';
          else if (['remote','apple','banana','orange','clock'].includes(c)) g = 'egg';
          else if (['umbrella','baseball bat'].includes(c)) g = 'key';

          if (g !== 'none' && p.score > bestScore) {
            bestScore = p.score;
            dominant = g;
          }
        });

        activateHand(dominant);
        lastGroups.push(dominant);
        if (lastGroups.length > 5) lastGroups.shift();

        resultEl.textContent =
          dominant === 'none'
            ? 'State: RELAXED'
            : `State: ${dominant.toUpperCase()}`;

        if (dominant !== 'none') {
          const cnt = lastGroups.filter(x => x === dominant).length;
          if (cnt >= 3) {
            freezeGroup = dominant;
            freezeUntil = now + getFreezeDurationMs();
            statusEl.textContent = 'DO_MASTER_Grip_This?';
          }
        }

        latestHudLine =
          `detectFPS=${detectFps} drawFPS=${drawFps} dominant=${dominant}`;

      } catch (e) {
        console.error(e);
        latestHudLine = 'Detection error';
      }

      setTimeout(loop, 200);
    };

    loop();
  }

  // ======== Camera ========
  async function startCamera() {
    try {
      await loadModelIfNeeded();

      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }

      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: 'environment' } },
        audio: false
      });

      video.srcObject = stream;

      video.onloadedmetadata = async () => {
        await video.play();

        if (!drawRunning) {
          drawRunning = true;
          drawLoop();
        }
        if (!detectRunning) {
          detectRunning = true;
          runDetectionLoop();
        }

        statusEl.textContent = 'Camera started.';
        latestHudLine = 'Camera running';
      };

    } catch (e) {
      console.error(e);
      statusEl.textContent = 'Camera error';
    }
  }

  // ======== Buttons ========
  function demoFreeze(ms=2000) {
    demoUntil = performance.now() + ms;
  }

  simEggBtn.addEventListener('click', () => {
    activateHand('egg');
    demoFreeze();
  });
  simPenBtn.addEventListener('click', () => {
    activateHand('pen');
    demoFreeze();
  });
  simPhoneBtn.addEventListener('click', () => {
    activateHand('phone');
    demoFreeze();
  });
  simKeyBtn.addEventListener('click', () => {
    activateHand('key');
    demoFreeze();
  });
  simSaluteBtn.addEventListener('click', () => {
    activateHand('salute');
    demoFreeze();
  });

  lockBtn.addEventListener('click', () => {
    lockActive = true;
    statusEl.textContent = 'Locked';
  });

  miniOpenBtn.addEventListener('click', () => {
    lockActive = false;
    statusEl.textContent = 'Mini-Open';
  });

  relaxBtn.addEventListener('click', () => {
    lockActive = false;
    freezeUntil = 0;
    lastGroups = [];
    activateHand('none');
    statusEl.textContent = 'Full Relax';
  });

  startCamBtn.addEventListener('click', startCamera);

})();
</script>
<script>
/* ===== Hand PNG Switcher ===== */
const handImgs = {
  none:   document.getElementById('img-open'),
  open:   document.getElementById('img-open'),
  phone:  document.getElementById('img-phone'),
  pen:    document.getElementById('img-pen'),
  key:    document.getElementById('img-key'),
  egg:    document.getElementById('img-egg'),
  salute: document.getElementById('img-salute')
};

function showHandImage(group) {
  Object.values(handImgs).forEach(img => img.classList.remove('active'));
  const target = handImgs[group] || handImgs.open;
  target.classList.add('active');
}

/* hook existing logic */
const _origActivateHand = window.activateHand;
window.activateHand = function(group) {
  try { showHandImage(group); } catch(e){}
  if (typeof _origActivateHand === 'function') {
    _origActivateHand(group);
  }
};
</script>
