<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>fcAI DIY + COCO (PNG Hand Edition)</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>

<style>
html,body{
  margin:0;padding:0;background:#000;color:#fff;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  height:100%;overflow:hidden;
}
#container{position:relative;width:100vw;height:100vh;}
video,canvas{
  position:absolute;top:0;left:0;width:100%;height:100%;
  object-fit:cover;
}
#overlayHud{
  position:absolute;top:6px;left:6px;
  background:rgba(0,0,0,.45);
  padding:6px 8px;font-size:12px;border-radius:6px;
  z-index:20;white-space:pre;
}
#handLayer{
  position:absolute;bottom:8%;left:50%;
  transform:translateX(-50%);
  z-index:15;
}
.handImg{
  position:absolute;left:50%;bottom:0;
  transform:translateX(-50%);
  width:70vw;max-width:420px;
  opacity:.45;
  display:none;
}
.handImg.active{display:block;}
.handImg.locked{opacity:.65;filter:drop-shadow(0 0 12px yellow);}
#menuToggle{
  position:absolute;bottom:10px;left:10px;z-index:30;
}
#menuPanel{
  position:absolute;bottom:60px;left:10px;
  background:rgba(0,0,0,.8);
  padding:10px;border-radius:10px;
  z-index:30;display:none;
}
#menuPanel.show{display:block;}
button,select{
  margin:4px 0;width:100%;
}
#debugHud{
  position:absolute;top:60px;right:10px;
  background:rgba(0,0,0,.85);
  padding:10px;white-space:pre;
  font-size:11px;display:none;z-index:40;
}
</style>
</head>

<body>
<div id="container">

<video id="video" playsinline muted autoplay></video>
<canvas id="renderCanvas"></canvas>

<div id="overlayHud">booting…</div>

<div id="handLayer">
  <img id="hand_open"   class="handImg active" src="hand_open.png">
  <img id="hand_phone"  class="handImg" src="hand_phone.png">
  <img id="hand_pen"    class="handImg" src="hand_pen.png">
  <img id="hand_key"    class="handImg" src="hand_key.png">
  <img id="hand_salute" class="handImg" src="hand_salute.png">
  <img id="hand_egg"    class="handImg" src="hand_egg.png">
</div>

<button id="menuToggle">☰ MENU</button>
<div id="menuPanel">
  <button id="startCamBtn">Start Camera</button>
  <button id="lockBtn">Lock</button>
  <button id="miniOpenBtn">Mini-Open</button>
  <button id="relaxBtn">Relax</button>
  <hr>
  <label>HUD DEBUG
    <select id="debugHudSelect">
      <option value="off">off</option>
      <option value="on">on</option>
    </select>
  </label>
</div>
<div id="debugHud"></div>
<script>
(() => {

const video = document.getElementById('video');
const canvas = document.getElementById('renderCanvas');
const ctx = canvas.getContext('2d');
const hud = document.getElementById('overlayHud');
const debugHud = document.getElementById('debugHud');

const imgs = {
  open:   document.getElementById('hand_open'),
  phone:  document.getElementById('hand_phone'),
  pen:    document.getElementById('hand_pen'),
  key:    document.getElementById('hand_key'),
  salute: document.getElementById('hand_salute'),
  egg:    document.getElementById('hand_egg')
};
const allImgs = Object.values(imgs);

let model=null, stream=null;
let current='open', locked=false, freezeUntil=0;
let lastGroups=[];

function showHand(g){
  allImgs.forEach(i=>i.classList.remove('active'));
  imgs[g]?.classList.add('active');
  current=g;
}

function lockVisual(on){
  allImgs.forEach(i=>i.classList.remove('locked'));
  if(on) imgs[current]?.classList.add('locked');
}

async function startCamera(){
  model ||= await cocoSsd.load();
  stream = await navigator.mediaDevices.getUserMedia({
    video:{facingMode:{ideal:'environment'}},audio:false
  });
  video.srcObject=stream;
  await video.play();
  loopDetect();
  loopDraw();
}

function mapClass(c){
  c=c.toLowerCase();
  if(c==='cell phone') return 'phone';
  if(['scissors','toothbrush','knife','fork','spoon'].includes(c)) return 'pen';
  if(['umbrella','wine glass'].includes(c)) return 'key';
  if(['apple','banana','orange','frisbee','clock'].includes(c)) return 'egg';
  return null;
}

async function loopDetect(){
  if(locked){setTimeout(loopDetect,200);return;}
  if(Date.now()<freezeUntil){setTimeout(loopDetect,200);return;}
  const preds = await model.detect(video);
  let best=null,score=0;
  preds.forEach(p=>{
    const g=mapClass(p.class);
    if(g && p.score>score){score=p.score;best=g;}
  });
  if(best){
    lastGroups.push(best);
    if(lastGroups.length>5) lastGroups.shift();
    if(lastGroups.filter(x=>x===best).length>=3){
      showHand(best);
      freezeUntil=Date.now()+5000;
    }
  }
  hud.textContent=`pose: ${current}\nrecognition: ${!!best}`;
  setTimeout(loopDetect,200);
}

function loopDraw(){
  requestAnimationFrame(loopDraw);
  if(!video.videoWidth) return;
  canvas.width=canvas.clientWidth;
  canvas.height=canvas.clientHeight;
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
}

document.getElementById('menuToggle').onclick=()=>{
  document.getElementById('menuPanel').classList.toggle('show');
};
document.getElementById('startCamBtn').onclick=startCamera;
document.getElementById('lockBtn').onclick=()=>{
  locked=true;lockVisual(true);
};
document.getElementById('miniOpenBtn').onclick=()=>{
  lockVisual(false);
};
document.getElementById('relaxBtn').onclick=()=>{
  locked=false;freezeUntil=0;lastGroups=[];
  showHand('open');lockVisual(false);
};
document.getElementById('debugHudSelect').onchange=e=>{
  debugHud.style.display=e.target.value==='on'?'block':'none';
};

})();
</script>

</div>
</body>
</html>
