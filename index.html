
/* ===== PART 01 / 16 : START ===== */
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no" />

<title>Colorful Custom Hand AI Project</title>

<!-- ====== Core Styles ====== -->
<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  background: #000;
  color: #fff;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  overflow: hidden;
}
<script>alert("JS ALIVE");</script>
/* ====== App Frame ====== */
#appRoot {
  position: relative;
  width: 100vw;
  height: 100vh;
  background: #000;
}

/* ====== Header ====== */
#titleBar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 56px;
  background: #111;
  display: flex;
  align-items: center;
  padding: 0 12px;
  z-index: 20;
  box-sizing: border-box;
}

#titleStack {
  flex: 1;
}

#titleStack .t1 {
  font-size: 15px;
  font-weight: 600;
  line-height: 1.1;
}

#titleStack .t2 {
  font-size: 11px;
  opacity: 0.75;
}

/* ====== Menu Button ====== */
#menuToggle {
  width: 40px;
  height: 40px;
  border-radius: 8px;
  background: #222;
  color: #fff;
  border: none;
  font-size: 20px;
}

/* ====== Menu Panel ====== */
#menuPanel {
  position: fixed;
  top: 56px;
  right: 0;
  width: 280px;
  max-height: calc(100vh - 56px);
  background: #1a1a1a;
  overflow-y: auto;
  z-index: 30;
  box-shadow: -4px 0 12px rgba(0,0,0,0.5);
}

#menuPanel.hidden {
  display: none;
}

.menu-section {
  padding: 12px;
  border-bottom: 1px solid #333;
}

.menu-section h3 {
  margin: 0 0 6px 0;
  font-size: 13px;
  font-weight: 600;
}

/* ====== Camera Layer ====== */
#cameraLayer {
  position: absolute;
  top: 56px;
  left: 0;
  right: 0;
  bottom: 120px;
  background: #000;
  overflow: hidden;
}

#video {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
}

#overlay {
  position: absolute;
  inset: 0;
  pointer-events: none;
}

/* ====== Hand Layer ====== */
#handLayer {
  position: absolute;
  inset: 0;
  pointer-events: none;
}

/* All hand images initially hidden */
.handPose {
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  max-width: 90vmin;
  max-height: 90vmin;
  opacity: 0.35; /* ← 薄め指定（後続で微調整） */
  display: none;
}

/* ====== Status Area ====== */
#statusArea {
  position: fixed;
  bottom: 64px;
  left: 0;
  right: 0;
  padding: 6px 10px;
  font-size: 14px;
  background: rgba(0,0,0,0.65);
  z-index: 15;
}

/* ====== Controls ====== */
#controls {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #111;
  padding: 8px;
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 6px;
  z-index: 20;
}

#controls button {
  background: #eee;
  color: #000;
  border: none;
  padding: 8px 4px;
  border-radius: 6px;
  font-size: 13px;
}

/* ====== Debug HUD ====== */
#debugHud {
  position: fixed;
  top: 56px;
  left: 0;
  right: 0;
  max-height: 60vh;
  background: rgba(0,0,0,0.9);
  color: #0f0;
  font-size: 11px;
  white-space: pre-wrap;
  overflow-y: auto;
  z-index: 40;
  display: none;
}

</style>

<!-- ====== External Libraries (loaded later in PART 02) ====== -->

</head>

<body>
<div id="appRoot">

  <!-- ===== Header ===== -->
  <div id="titleBar">
    <div id="titleStack">
      <div class="t1">Colorful Custom Hand AI Project</div>
      <div class="t2">fcAI + DIY Mode</div>
    </div>
    <button id="menuToggle">☰</button>
  </div>

  <!-- ===== Menu Panel ===== -->
  <div id="menuPanel" class="hidden">
    <!-- menu contents injected later -->
  </div>

  <!-- ===== Camera & Overlay ===== -->
  <div id="cameraLayer">
    <video id="video" autoplay muted playsinline></video>
    <canvas id="overlay"></canvas>

    <!-- ===== Hand Images ===== -->
    <div id="handLayer">
      <!-- filenames are FINAL per your instruction -->
      <img id="handRelaxed" class="handPose" src="hand_relaxed.png" />
      <img id="handPhone"   class="handPose" src="hand_phone.png" />
      <img id="handPen"     class="handPose" src="hand_pen.png" />
      <img id="handKey"     class="handPose" src="hand_key.png" />
      <img id="handEgg"     class="handPose" src="hand_egg.png" />
      <img id="handSalute"  class="handPose" src="hand_salute.png" />
    </div>
  </div>

  <!-- ===== Status ===== -->
  <div id="statusArea">
    <div id="status">Booting...</div>
    <div id="result">State: RELAXED</div>
  </div>

  <!-- ===== Controls ===== -->
  <div id="controls">
    <button id="startCamBtn">Start Camera</button>
    <button id="lockBtn">Lock</button>
    <button id="miniOpenBtn">Mini-Open</button>
    <button id="relaxBtn">Relax</button>

    <button id="simEggBtn">EGG</button>
    <button id="simPenBtn">PEN</button>
    <button id="simPhoneBtn">PHONE</button>
    <button id="simKeyBtn">KEY</button>
    <button id="simSaluteBtn">SALUTE</button>
  </div>

  <!-- ===== Debug HUD ===== -->
  <div id="debugHud">
    <pre id="debugText"></pre>
  </div>

</div>
/* ===== PART 01 / 16 : END ===== */
  /* ===== PART 02 / 16 : START ===== */

<!-- ====== External Libraries ====== -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-cpu"></script>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-layers"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

<script>
(() => {
  /* ========= DOM ========= */
  const video        = document.getElementById('video');
  const overlay      = document.getElementById('overlay');
  const overlayCtx   = overlay.getContext('2d');

  const menuToggle   = document.getElementById('menuToggle');
  const menuPanel    = document.getElementById('menuPanel');

  const statusEl     = document.getElementById('status');
  const resultEl     = document.getElementById('result');

  const debugHud     = document.getElementById('debugHud');
  const debugText    = document.getElementById('debugText');

  const startCamBtn  = document.getElementById('startCamBtn');
  const lockBtn      = document.getElementById('lockBtn');
  const miniOpenBtn  = document.getElementById('miniOpenBtn');
  const relaxBtn     = document.getElementById('relaxBtn');

  const simEggBtn    = document.getElementById('simEggBtn');
  const simPenBtn    = document.getElementById('simPenBtn');
  const simPhoneBtn  = document.getElementById('simPhoneBtn');
  const simKeyBtn    = document.getElementById('simKeyBtn');
  const simSaluteBtn = document.getElementById('simSaluteBtn');

  /* ========= Hand Images ========= */
  const handImgs = {
    none   : document.getElementById('handRelaxed'),
    phone  : document.getElementById('handPhone'),
    pen    : document.getElementById('handPen'),
    key    : document.getElementById('handKey'),
    egg    : document.getElementById('handEgg'),
    salute : document.getElementById('handSalute')
  };

  const allHandImgs = Object.values(handImgs);

  function showHand(name) {
    allHandImgs.forEach(img => img.style.display = 'none');
    const t = handImgs[name] || handImgs.none;
    if (t) t.style.display = 'block';
  }

  showHand('none'); // initial relaxed

  /* ========= State ========= */
  let stream = null;
  let model = null;

  let detectRunning = false;
  let lockActive = false;

  let freezeUntil = 0;
  let lastGroup = 'none';

  /* ========= UI ========= */
  menuToggle.addEventListener('click', () => {
    menuPanel.classList.toggle('hidden');
  });

  function logHUD(msg) {
    debugText.textContent = msg;
  }

  statusEl.textContent = 'Booting...';

  /* ========= Helpers ========= */
  function resizeOverlay() {
    const dpr = window.devicePixelRatio || 1;
    const w = overlay.clientWidth;
    const h = overlay.clientHeight;
    overlay.width  = Math.floor(w * dpr);
    overlay.height = Math.floor(h * dpr);
    overlayCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }

  window.addEventListener('resize', resizeOverlay);

  /* ========= Model Load ========= */
  async function loadModel() {
    if (model) return model;
    statusEl.textContent = 'Loading COCO-SSD...';
    try {
      if (tf.getBackend() !== 'webgl') {
        await tf.setBackend('webgl');
      }
    } catch(e) {
      try { await tf.setBackend('cpu'); } catch(_) {}
    }
    model = await cocoSsd.load();
    statusEl.textContent = 'Model loaded.';
    return model;
  }

/* ===== PART 02 / 16 : END ===== */
 /* ===== PART 03 / 16 : START ===== */

  /* ========= Camera ========= */
  async function startCamera() {
    if (stream) return;

    statusEl.textContent = 'Starting camera...';

    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { ideal: 'environment' },
          width: { ideal: 1280 },
          height: { ideal: 720 }
        },
        audio: false
      });

      video.srcObject = stream;
      await video.play();

      resizeOverlay();

      statusEl.textContent = 'Camera started.';
      logHUD('Camera OK');

    } catch (e) {
      console.error(e);
      statusEl.textContent = 'Camera failed.';
      logHUD('Camera ERROR');
    }
  }

  startCamBtn.addEventListener('click', async () => {
    await startCamera();
    await loadModel(); // ← ここで初めてモデルロード
  });

  /* ========= Draw Loop ========= */
  function drawVideoToOverlay() {
    requestAnimationFrame(drawVideoToOverlay);

    if (!video.videoWidth || video.readyState < 2) return;

    resizeOverlay();

    overlayCtx.clearRect(0, 0, overlay.width, overlay.height);

    // NOTE:
    // video 自体は <video> 要素で表示
    // overlay は bbox / HUD 用（ここでは空）
  }

  requestAnimationFrame(drawVideoToOverlay);

  /* ========= Visibility ========= */
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      logHUD('tab hidden');
    } else {
      logHUD('tab visible');
    }
  });

/* ===== PART 03 / 16 : END ===== */
 /* ===== PART 04 / 16 : START ===== */

  /* ========= COCO-SSD ========= */
  let cocoModel = null;
  let detectRunning = false;
  let lastPredictions = [];

  async function loadModel() {
    if (cocoModel) return;

    statusEl.textContent = 'Loading COCO-SSD...';
    logHUD('Loading COCO-SSD');

    try {
      cocoModel = await cocoSsd.load();
      statusEl.textContent = 'COCO-SSD loaded.';
      logHUD('COCO-SSD OK');
    } catch (e) {
      console.error(e);
      statusEl.textContent = 'COCO-SSD load failed.';
      logHUD('COCO-SSD ERROR');
    }
  }

  /* ========= Detection Loop ========= */
  async function runDetectionLoop() {
    if (detectRunning) return;
    detectRunning = true;

    async function loop() {
      if (!detectRunning) return;

      if (!cocoModel || !video.videoWidth || video.readyState < 2) {
        requestAnimationFrame(loop);
        return;
      }

      try {
        const predictions = await cocoModel.detect(video);
        lastPredictions = predictions;

        hudLine.textContent =
          `COCO running | objects=${predictions.length}`;

      } catch (e) {
        console.error(e);
        logHUD('detect error');
      }

      setTimeout(loop, 200); // 約5Hz
    }

    loop();
  }

  /* ========= Start Detection ========= */
  startDetectBtn.addEventListener('click', async () => {
    if (!cocoModel) {
      await loadModel();
    }
    runDetectionLoop();
    statusEl.textContent = 'Detection started.';
    logHUD('Detection ON');
  });

  stopDetectBtn.addEventListener('click', () => {
    detectRunning = false;
    statusEl.textContent = 'Detection stopped.';
    logHUD('Detection OFF');
  });

/* ===== PART 04 / 16 : END ===== */
 /* ===== PART 05 / 16 : START ===== */

  /* ========= Overlay Canvas ========= */
  const overlay = document.getElementById('overlay');
  const octx = overlay.getContext('2d');

  function resizeOverlay() {
    if (!video.videoWidth) return;
    overlay.width  = video.videoWidth;
    overlay.height = video.videoHeight;
  }

  window.addEventListener('resize', resizeOverlay);
  video.addEventListener('loadedmetadata', resizeOverlay);

  /* ========= Draw Loop ========= */
  let drawRunning = false;

  function startDrawLoop() {
    if (drawRunning) return;
    drawRunning = true;

    function draw() {
      if (!drawRunning) return;

      octx.clearRect(0, 0, overlay.width, overlay.height);

      if (lastPredictions && lastPredictions.length > 0) {
        lastPredictions.forEach(p => {
          const [x, y, w, h] = p.bbox;

          // box
          octx.strokeStyle = 'rgba(0,255,255,0.9)';
          octx.lineWidth = 3;
          octx.strokeRect(x, y, w, h);

          // label
          octx.fillStyle = 'rgba(0,0,0,0.6)';
          octx.fillRect(x, y - 18, octx.measureText(p.class).width + 10, 18);

          octx.fillStyle = '#00ffff';
          octx.font = '14px monospace';
          octx.fillText(
            `${p.class} ${(p.score * 100).toFixed(0)}%`,
            x + 4,
            y - 4
          );
        });

        hudLine.textContent =
          `COCO drawing | boxes=${lastPredictions.length}`;
      } else {
        hudLine.textContent =
          'COCO drawing | no objects';
      }

      requestAnimationFrame(draw);
    }

    draw();
  }

  function stopDrawLoop() {
    drawRunning = false;
    octx.clearRect(0, 0, overlay.width, overlay.height);
  }

  /* ========= Hook ========= */
  startDetectBtn.addEventListener('click', () => {
    startDrawLoop();
    logHUD('Draw loop ON');
  });

  stopDetectBtn.addEventListener('click', () => {
    stopDrawLoop();
    logHUD('Draw loop OFF');
  });

/* ===== PART 05 / 16 : END ===== */
 /* ===== PART 06 / 16 : START ===== */

  /* ========= Class Mapping ========= */
  const COCO_GROUP_MAP = {
    phone: ['cell phone'],
    pen:   ['pen'],
    key:   ['key'],
    egg:   ['egg', 'orange'], // egg代替（実験）
    salute: ['person']
  };

  function mapCocoClassToGroup(cocoClass) {
    for (const g in COCO_GROUP_MAP) {
      if (COCO_GROUP_MAP[g].includes(cocoClass)) return g;
    }
    return 'ignore';
  }

  /* ========= Dominant Detection ========= */
  let lastDominantGroup = 'none';
  let lastDominantScore = 0;

  function computeDominant(predictions) {
    let best = { group: 'none', score: 0 };

    predictions.forEach(p => {
      const group = mapCocoClassToGroup(p.class);
      if (group === 'ignore') return;

      if (p.score > best.score) {
        best.group = group;
        best.score = p.score;
      }
    });

    return best;
  }

  /* ========= Integrate ========= */
  function updateDominantFromCOCO() {
    if (!lastPredictions || lastPredictions.length === 0) {
      lastDominantGroup = 'none';
      lastDominantScore = 0;
      return;
    }

    const d = computeDominant(lastPredictions);
    lastDominantGroup = d.group;
    lastDominantScore = d.score;

    hudLine.textContent =
      `COCO dominant=${lastDominantGroup} ${(lastDominantScore*100).toFixed(0)}%`;
  }

  /* ========= Hook into draw loop ========= */
  const _origDraw = startDrawLoop;
  startDrawLoop = function () {
    _origDraw();
    setInterval(() => {
      updateDominantFromCOCO();
    }, 250);
  };

/* ===== PART 06 / 16 : END ===== */
 /* ===== PART 07 / 16 : START ===== */

  /* ========= Hand PNG (RELAX only) ========= */

  const handLayer = document.createElement('img');
  handLayer.id = 'handLayer';
  handLayer.src = 'hand_open.png';   // ← 確定ファイル名
  handLayer.style.position = 'absolute';
  handLayer.style.inset = '0';
  handLayer.style.width = '100%';
  handLayer.style.height = '100%';
  handLayer.style.objectFit = 'contain';
  handLayer.style.pointerEvents = 'none';
  handLayer.style.opacity = '0.35';   // ← 半透明（さらに薄く）
  handLayer.style.zIndex = '20';       // video(1) canvas(2) svg(3) より上

  const videoWrap = document.getElementById('videoWrapper');
  videoWrap.appendChild(handLayer);

  /* ========= Update Hand by Dominant ========= */
  function updateHandImage() {
    if (!handLayer) return;

    if (lastDominantGroup === 'none') {
      handLayer.src = 'hand_open.png';
      handLayer.style.display = 'block';
    } else {
      // まだ他の絵は出さない（次PART）
      handLayer.style.display = 'none';
    }
  }

  /* ========= Hook ========= */
  setInterval(() => {
    updateHandImage();
  }, 200);

/* ===== PART 07 / 16 : END ===== */
